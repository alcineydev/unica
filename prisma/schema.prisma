generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

/// Cidades cadastradas pelo admin (dinâmicas)
model City {
  id            String         @id @default(cuid())
  name          String         @unique
  state         String         @db.VarChar(2)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  assinantes    Assinante[]
  notifications Notification[]
  parceiros     Parceiro[]

  @@index([state])
  @@index([isActive])
  @@map("cities")
}

/// Usuário base do sistema
model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  role      Role       @default(ASSINANTE)
  avatar    String?
  phone     String?
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  admin     Admin?
  assinante Assinante?
  parceiro  Parceiro?
  pushSubscriptions      PushSubscription[]
  adminPushNotifications AdminPushNotification[]

  @@index([role])
  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}

/// Administrador do sistema (criado pelo Developer)
model Admin {
  id          String   @id @default(cuid())
  userId      String   @unique
  name        String
  phone       String
  permissions Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admins")
}

/// Benefício modular (peça/componente)
model Benefit {
  id            String          @id @default(cuid())
  name          String
  description   String
  type          BenefitType
  value         Json
  category      String?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  benefitAccess BenefitAccess[]
  planBenefits  PlanBenefit[]

  @@index([type])
  @@index([isActive])
  @@map("benefits")
}

/// Plano de assinatura (composição de benefícios + preço)
model Plan {
  id            String         @id @default(cuid())
  name          String
  description   String
  price         Decimal        @db.Decimal(10, 2)
  period        String         @default("MONTHLY")
  features      String[]       @default([])
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  priceMonthly  Decimal?       @db.Decimal(10, 2)
  priceSingle   Decimal?       @db.Decimal(10, 2)
  priceYearly   Decimal?       @db.Decimal(10, 2)
  slug          String?        @unique
  assinantes    Assinante[]
  notifications Notification[]
  planBenefits  PlanBenefit[]

  @@index([isActive])
  @@index([price])
  @@map("plans")
}

/// Pivot: Plano <-> Benefício (com config específica por plano)
model PlanBenefit {
  id        String   @id @default(cuid())
  planId    String
  benefitId String
  config    Json?
  createdAt DateTime @default(now())
  benefit   Benefit  @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  plan      Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, benefitId])
  @@map("plan_benefits")
}

/// Categoria de parceiros
model Category {
  id           String     @id @default(uuid())
  name         String
  slug         String     @unique
  icon         String     @default("Store")
  banner       String
  description  String?
  displayOrder Int        @default(0) @map("display_order")
  isActive     Boolean    @default(true) @map("is_active")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  parceiros    Parceiro[]

  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

/// Parceiro / Empresa local
model Parceiro {
  id            String                @id @default(cuid())
  userId        String                @unique
  cnpj          String                @unique @db.VarChar(14)
  companyName   String
  tradeName     String?
  logo          String?
  banner        String?
  gallery       String[]              @default([])
  category       String
  categoryId     String?        @map("category_id")
  categoryRef    Category?      @relation(fields: [categoryId], references: [id])
  description    String?
  isDestaque     Boolean        @default(false) @map("is_destaque")
  bannerDestaque String?        @map("banner_destaque")
  destaqueOrder  Int            @default(0) @map("destaque_order")
  cityId         String
  address       Json
  contact       Json
  hours         Json
  balance       Decimal               @default(0) @db.Decimal(10, 2)
  metrics       Json                  @default("{\"pageViews\": 0, \"totalSales\": 0, \"salesAmount\": 0, \"whatsappClicks\": 0}")
  isActive      Boolean               @default(true)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  benefitAccess BenefitAccess[]
  city          City                  @relation(fields: [cityId], references: [id])
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]
  notificacoes  ParceiroNotificacao[]
  avaliacoes    Avaliacao[]

  @@index([isActive])
  @@index([categoryId])
  @@index([cityId])
  @@index([isDestaque])
  @@map("parceiros")
}

/// Notificação do parceiro (vendas, avaliações, etc)
model ParceiroNotificacao {
  id         String   @id @default(cuid())
  parceiroId String
  tipo       String   // venda, avaliacao, cliente, info
  titulo     String
  mensagem   String
  lida       Boolean  @default(false)
  createdAt  DateTime @default(now())
  parceiro   Parceiro @relation(fields: [parceiroId], references: [id], onDelete: Cascade)

  @@index([parceiroId])
  @@index([createdAt])
  @@map("parceiro_notificacoes")
}

/// Assinante / Cliente do clube
model Assinante {
  id                 String             @id @default(cuid())
  userId             String             @unique
  cpf                String?            @unique @db.VarChar(11)
  name               String
  phone              String?
  birthDate          DateTime?
  cityId             String?
  address            Json?
  planId             String?
  subscriptionStatus SubscriptionStatus @default(PENDING)
  points             Decimal            @default(0) @db.Decimal(10, 2)
  cashback           Decimal            @default(0) @db.Decimal(10, 2)
  qrCode             String             @unique
  planStartDate      DateTime?
  planEndDate        DateTime?
  nextBillingDate    DateTime?
  lastPaymentDate    DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  city               City?              @relation(fields: [cityId], references: [id])
  plan               Plan?              @relation(fields: [planId], references: [id])
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions       Transaction[]
  avaliacoes         Avaliacao[]
  notificacoes       AssinanteNotificacao[]

  @@index([subscriptionStatus])
  @@index([planId])
  @@index([cityId])
  @@map("assinantes")
}

/// Notificação do assinante (compras, avaliações, pontos, etc)
model AssinanteNotificacao {
  id          String    @id @default(cuid())
  assinanteId String
  tipo        String    // AVALIACAO, COMPRA, PONTOS, CASHBACK, INFO
  titulo      String
  mensagem    String
  dados       Json?     // { parceiroId, link, etc }
  lida        Boolean   @default(false)
  createdAt   DateTime  @default(now())
  assinante   Assinante @relation(fields: [assinanteId], references: [id], onDelete: Cascade)

  @@index([assinanteId])
  @@index([createdAt])
  @@map("assinante_notificacoes")
}

/// Pivot: Benefício <-> Parceiro (quais benefícios o parceiro aceita)
model BenefitAccess {
  id         String   @id @default(cuid())
  benefitId  String
  parceiroId String
  config     Json?
  createdAt  DateTime @default(now())
  benefit    Benefit  @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  parceiro   Parceiro @relation(fields: [parceiroId], references: [id], onDelete: Cascade)

  @@unique([benefitId, parceiroId])
  @@map("benefit_access")
}

/// Transação (compra, cashback, bônus, etc)
model Transaction {
  id                String            @id @default(cuid())
  type              TransactionType
  assinanteId       String
  parceiroId        String?
  amount            Decimal           @db.Decimal(10, 2)
  pointsUsed        Decimal           @default(0) @db.Decimal(10, 2)
  cashbackGenerated Decimal           @default(0) @db.Decimal(10, 2)
  discountApplied   Decimal           @default(0) @db.Decimal(10, 2)
  description       String
  status            TransactionStatus
  metadata          Json?
  createdAt         DateTime          @default(now())
  assinante         Assinante         @relation(fields: [assinanteId], references: [id], onDelete: Cascade)
  parceiro          Parceiro?         @relation(fields: [parceiroId], references: [id])

  @@index([assinanteId])
  @@index([parceiroId])
  @@index([createdAt])
  @@map("transactions")
}

/// Configurações do sistema
model Config {
  id          String         @id @default(cuid())
  key         String         @unique
  value       String
  description String
  category    ConfigCategory
  updatedAt   DateTime       @updatedAt

  @@map("configs")
}

/// Integrações externas (Evolution API, Mercado Pago, etc)
model Integration {
  id        String          @id @default(cuid())
  type      IntegrationType @unique
  name      String
  config    Json
  isActive  Boolean         @default(true)
  lastSync  DateTime?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@map("integrations")
}

/// Logs do sistema (para developer)
model SystemLog {
  id        String   @id @default(cuid())
  level     String
  action    String
  userId    String?
  details   Json?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([level])
  @@index([action])
  @@index([userId])
  @@index([createdAt])
  @@map("system_logs")
}

/// Instância do WhatsApp conectada via Evolution API
model WhatsAppInstance {
  id            String         @id @default(cuid())
  name          String
  instanceId    String         @unique
  status        String         @default("disconnected")
  phoneNumber   String?
  profileName   String?
  profilePic    String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  notifications Notification[]

  @@map("whatsapp_instances")
}

/// Notificação/Mensagem em massa via WhatsApp
model Notification {
  id               String             @id @default(cuid())
  title            String
  message          String
  imageUrl         String?
  linkUrl          String?
  linkText         String?
  targetType       TargetType
  targetPlanId     String?
  targetCityId     String?
  instanceId       String
  sentAt           DateTime?
  sentCount        Int                @default(0)
  failedCount      Int                @default(0)
  status           NotificationStatus @default(DRAFT)
  errorLog         String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  individualNumber String?
  instance         WhatsAppInstance   @relation(fields: [instanceId], references: [id])
  targetCity       City?              @relation(fields: [targetCityId], references: [id])
  targetPlan       Plan?              @relation(fields: [targetPlanId], references: [id])

  @@index([status])
  @@index([createdAt])
  @@index([sentAt])
  @@map("notifications")
}

enum Role {
  DEVELOPER
  ADMIN
  PARCEIRO
  ASSINANTE
}

enum BenefitType {
  DESCONTO
  CASHBACK
  PONTOS
  ACESSO_EXCLUSIVO
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  INACTIVE
  SUSPENDED
  CANCELED
  EXPIRED
}

enum TransactionType {
  PURCHASE
  CASHBACK
  BONUS
  MONTHLY_POINTS
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum ConfigCategory {
  PAYMENT
  INTEGRATION
  BUSINESS
  SYSTEM
}

enum IntegrationType {
  EVOLUTION_API
  EMAIL
  SMS
  PAYMENT
}

enum TargetType {
  ALL_ASSINANTES
  PLANO_ESPECIFICO
  ALL_PARCEIROS
  PARCEIROS_CIDADE
  TODOS
  INDIVIDUAL
}

enum NotificationStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PARTIAL
  FAILED
}

/// Configurações do PWA (Progressive Web App)
model PWAConfig {
  id                String   @id @default(cuid())
  
  // Informações básicas
  appName           String   @default("UNICA")
  shortName         String   @default("UNICA")
  description       String   @default("Seu clube de benefícios e descontos exclusivos")
  
  // Cores
  themeColor        String   @default("#000000")
  backgroundColor   String   @default("#ffffff")
  
  // Ícones
  icon72            String?
  icon96            String?
  icon128           String?
  icon144           String?
  icon152           String?
  icon192           String?
  icon384           String?
  icon512           String?
  
  // Splash Screens
  splashIphone5     String?  // 640x1136
  splashIphone6     String?  // 750x1334
  splashIphonePlus  String?  // 1242x2208
  splashIphoneX     String?  // 1125x2436
  splashIphoneXr    String?  // 828x1792
  splashIphoneXsMax String?  // 1242x2688
  splashIpad        String?  // 1536x2048
  splashIpadPro     String?  // 2048x2732
  
  // Configurações avançadas
  display           String   @default("standalone") // standalone, fullscreen, minimal-ui, browser
  orientation       String   @default("portrait-primary")
  startUrl          String   @default("/")
  scope             String   @default("/")
  
  // Screenshots
  screenshot1       String?
  screenshot2       String?
  screenshot3       String?
  
  // Status
  isActive          Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("pwa_configs")
}

/// Interesse de parceria (leads de empresas interessadas)
model InteresseParceiro {
  id          String   @id @default(cuid())

  // Dados do contato
  nome        String
  email       String
  telefone    String

  // Dados da empresa
  nomeEmpresa String
  cidade      String

  // Controle
  status      String   @default("PENDENTE") // PENDENTE, CONTATADO, CONVERTIDO, REJEITADO
  observacoes String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("interesses_parceiros")
}

/// Avaliação do parceiro feita por assinantes
model Avaliacao {
  id          String    @id @default(uuid())

  // Relacionamentos
  assinanteId String
  assinante   Assinante @relation(fields: [assinanteId], references: [id], onDelete: Cascade)

  parceiroId  String
  parceiro    Parceiro  @relation(fields: [parceiroId], references: [id], onDelete: Cascade)

  // Dados da avaliação
  nota        Int       // 1-5 estrelas
  comentario  String?   // Opcional

  // Resposta do parceiro
  resposta     String?
  respondidoEm DateTime?

  // Controle de publicação
  publicada   Boolean   @default(false)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([assinanteId])
  @@index([parceiroId])
  @@map("avaliacoes")
}

/// Subscription de Push Notification por dispositivo
model PushSubscription {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  endpoint   String   @unique
  p256dh     String
  auth       String
  userAgent  String?  @map("user_agent")
  platform   String?
  deviceInfo String?  @map("device_info")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @map("updated_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

/// Histórico de Push Notifications enviadas pelo admin
model AdminPushNotification {
  id          String   @id @default(uuid())

  title       String
  message     String
  icon        String?
  link        String?

  targetType  String   // ALL, ASSINANTES, PARCEIROS

  sentCount   Int      @default(0)
  failedCount Int      @default(0)

  createdBy   String
  admin       User     @relation(fields: [createdBy], references: [id])

  createdAt   DateTime @default(now())

  @@map("admin_push_notifications")
}

/// Configurações do sistema (branding, cores, etc)
model SystemConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String?
  type        String   @default("text") // text, image, color, json
  category    String   @default("general") // general, branding, theme
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@index([key])
  @@map("system_config")
}

/// Páginas institucionais (Sobre, Termos, Privacidade, etc)
model Page {
  id              String   @id @default(uuid())
  title           String
  slug            String   @unique
  content         String?  @db.Text
  metaTitle       String?  @map("meta_title")
  metaDescription String?  @map("meta_description")
  isPublished     Boolean  @default(false) @map("is_published")
  showInFooter    Boolean  @default(false) @map("show_in_footer")
  footerOrder     Int      @default(0) @map("footer_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@index([isPublished])
  @@map("pages")
}
