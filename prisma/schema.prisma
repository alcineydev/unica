generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

/// Cidades cadastradas pelo admin (dinâmicas)
model City {
  id            String         @id @default(cuid())
  name          String         @unique
  state         String         @db.VarChar(2)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  assinantes    Assinante[]
  notifications Notification[]
  parceiros     Parceiro[]

  @@map("cities")
}

/// Usuário base do sistema
model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  role      Role       @default(ASSINANTE)
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  admin     Admin?
  assinante Assinante?
  parceiro  Parceiro?

  @@map("users")
}

/// Administrador do sistema (criado pelo Developer)
model Admin {
  id          String   @id @default(cuid())
  userId      String   @unique
  name        String
  phone       String
  permissions Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admins")
}

/// Benefício modular (peça/componente)
model Benefit {
  id            String          @id @default(cuid())
  name          String
  description   String
  type          BenefitType
  value         Json
  category      String?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  benefitAccess BenefitAccess[]
  planBenefits  PlanBenefit[]

  @@map("benefits")
}

/// Plano de assinatura (composição de benefícios + preço)
model Plan {
  id            String         @id @default(cuid())
  name          String
  description   String
  price         Decimal        @db.Decimal(10, 2)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  priceMonthly  Decimal?       @db.Decimal(10, 2)
  priceSingle   Decimal?       @db.Decimal(10, 2)
  priceYearly   Decimal?       @db.Decimal(10, 2)
  slug          String?        @unique
  assinantes    Assinante[]
  notifications Notification[]
  planBenefits  PlanBenefit[]

  @@map("plans")
}

/// Pivot: Plano <-> Benefício (com config específica por plano)
model PlanBenefit {
  id        String   @id @default(cuid())
  planId    String
  benefitId String
  config    Json?
  createdAt DateTime @default(now())
  benefit   Benefit  @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  plan      Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, benefitId])
  @@map("plan_benefits")
}

/// Parceiro / Empresa local
model Parceiro {
  id            String          @id @default(cuid())
  userId        String          @unique
  cnpj          String          @unique @db.VarChar(14)
  companyName   String
  tradeName     String?
  logo          String?
  category      String
  description   String?
  cityId        String
  address       Json
  contact       Json
  hours         Json
  balance       Decimal         @default(0) @db.Decimal(10, 2)
  metrics       Json            @default("{\"pageViews\": 0, \"totalSales\": 0, \"salesAmount\": 0, \"whatsappClicks\": 0}")
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  benefitAccess BenefitAccess[]
  city          City            @relation(fields: [cityId], references: [id])
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@map("parceiros")
}

/// Assinante / Cliente do clube
model Assinante {
  id                 String             @id @default(cuid())
  userId             String             @unique
  cpf                String             @unique @db.VarChar(11)
  name               String
  phone              String
  cityId             String?
  address            Json?
  planId             String?
  subscriptionStatus SubscriptionStatus @default(PENDING)
  points             Decimal            @default(0) @db.Decimal(10, 2)
  cashback           Decimal            @default(0) @db.Decimal(10, 2)
  qrCode             String             @unique
  planStartDate      DateTime?
  planEndDate        DateTime?
  nextBillingDate    DateTime?
  lastPaymentDate    DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  city               City?              @relation(fields: [cityId], references: [id])
  plan               Plan?              @relation(fields: [planId], references: [id])
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions       Transaction[]

  @@map("assinantes")
}

/// Pivot: Benefício <-> Parceiro (quais benefícios o parceiro aceita)
model BenefitAccess {
  id         String   @id @default(cuid())
  benefitId  String
  parceiroId String
  config     Json?
  createdAt  DateTime @default(now())
  benefit    Benefit  @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  parceiro   Parceiro @relation(fields: [parceiroId], references: [id], onDelete: Cascade)

  @@unique([benefitId, parceiroId])
  @@map("benefit_access")
}

/// Transação (compra, cashback, bônus, etc)
model Transaction {
  id                String            @id @default(cuid())
  type              TransactionType
  assinanteId       String
  parceiroId        String?
  amount            Decimal           @db.Decimal(10, 2)
  pointsUsed        Decimal           @default(0) @db.Decimal(10, 2)
  cashbackGenerated Decimal           @default(0) @db.Decimal(10, 2)
  discountApplied   Decimal           @default(0) @db.Decimal(10, 2)
  description       String
  status            TransactionStatus
  metadata          Json?
  createdAt         DateTime          @default(now())
  assinante         Assinante         @relation(fields: [assinanteId], references: [id], onDelete: Cascade)
  parceiro          Parceiro?         @relation(fields: [parceiroId], references: [id])

  @@index([assinanteId])
  @@index([parceiroId])
  @@index([createdAt])
  @@map("transactions")
}

/// Configurações do sistema
model Config {
  id          String         @id @default(cuid())
  key         String         @unique
  value       String
  description String
  category    ConfigCategory
  updatedAt   DateTime       @updatedAt

  @@map("configs")
}

/// Integrações externas (Evolution API, Mercado Pago, etc)
model Integration {
  id        String          @id @default(cuid())
  type      IntegrationType @unique
  name      String
  config    Json
  isActive  Boolean         @default(true)
  lastSync  DateTime?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@map("integrations")
}

/// Logs do sistema (para developer)
model SystemLog {
  id        String   @id @default(cuid())
  level     String
  action    String
  userId    String?
  details   Json?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([level])
  @@index([action])
  @@index([userId])
  @@index([createdAt])
  @@map("system_logs")
}

/// Instância do WhatsApp conectada via Evolution API
model WhatsAppInstance {
  id            String         @id @default(cuid())
  name          String
  instanceId    String         @unique
  status        String         @default("disconnected")
  phoneNumber   String?
  profileName   String?
  profilePic    String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  notifications Notification[]

  @@map("whatsapp_instances")
}

/// Notificação/Mensagem em massa via WhatsApp
model Notification {
  id               String             @id @default(cuid())
  title            String
  message          String
  imageUrl         String?
  linkUrl          String?
  linkText         String?
  targetType       TargetType
  targetPlanId     String?
  targetCityId     String?
  instanceId       String
  sentAt           DateTime?
  sentCount        Int                @default(0)
  failedCount      Int                @default(0)
  status           NotificationStatus @default(DRAFT)
  errorLog         String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  individualNumber String?
  instance         WhatsAppInstance   @relation(fields: [instanceId], references: [id])
  targetCity       City?              @relation(fields: [targetCityId], references: [id])
  targetPlan       Plan?              @relation(fields: [targetPlanId], references: [id])

  @@map("notifications")
}

enum Role {
  DEVELOPER
  ADMIN
  PARCEIRO
  ASSINANTE
}

enum BenefitType {
  DESCONTO
  CASHBACK
  PONTOS
  ACESSO_EXCLUSIVO
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CANCELED
}

enum TransactionType {
  PURCHASE
  CASHBACK
  BONUS
  MONTHLY_POINTS
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum ConfigCategory {
  PAYMENT
  INTEGRATION
  BUSINESS
  SYSTEM
}

enum IntegrationType {
  EVOLUTION_API
  EMAIL
  SMS
  PAYMENT
}

enum TargetType {
  ALL_ASSINANTES
  PLANO_ESPECIFICO
  ALL_PARCEIROS
  PARCEIROS_CIDADE
  TODOS
  INDIVIDUAL
}

enum NotificationStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PARTIAL
  FAILED
}
