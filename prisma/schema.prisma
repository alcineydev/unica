// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// ENUMS
// ==========================================

enum Role {
  DEVELOPER
  ADMIN
  PARCEIRO
  ASSINANTE
}

enum BenefitType {
  DESCONTO
  CASHBACK
  PONTOS
  ACESSO_EXCLUSIVO
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CANCELED
}

enum TransactionType {
  PURCHASE
  CASHBACK
  BONUS
  MONTHLY_POINTS
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum ConfigCategory {
  PAYMENT
  INTEGRATION
  BUSINESS
  SYSTEM
}

enum IntegrationType {
  EVOLUTION_API
  EMAIL
  SMS
  PAYMENT
}

// ==========================================
// MODELS
// ==========================================

/// Cidades cadastradas pelo admin (dinâmicas)
model City {
  id        String   @id @default(cuid())
  name      String   @unique
  state     String   @db.VarChar(2) // UF (ex: "MT")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parceiros  Parceiro[]
  assinantes Assinante[]

  @@map("cities")
}

/// Usuário base do sistema
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role     @default(ASSINANTE)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  admin     Admin?
  parceiro  Parceiro?
  assinante Assinante?

  @@map("users")
}

/// Administrador do sistema (criado pelo Developer)
model Admin {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  phone       String
  permissions Json     @default("{}") // Permissões específicas
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("admins")
}

/// Benefício modular (peça/componente)
model Benefit {
  id          String      @id @default(cuid())
  name        String
  description String
  type        BenefitType
  value       Json        // Config específica por tipo (percentage, fixedValue, etc)
  category    String?     // Categoria opcional (alimentacao, saude, etc)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  planBenefits  PlanBenefit[]
  benefitAccess BenefitAccess[]

  @@map("benefits")
}

/// Plano de assinatura (composição de benefícios + preço)
model Plan {
  id          String   @id @default(cuid())
  name        String
  description String
  price       Decimal  @db.Decimal(10, 2)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  planBenefits PlanBenefit[]
  assinantes   Assinante[]

  @@map("plans")
}

/// Pivot: Plano <-> Benefício (com config específica por plano)
model PlanBenefit {
  id        String   @id @default(cuid())
  planId    String
  plan      Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  benefitId String
  benefit   Benefit  @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  config    Json?    // Config específica para este plano (override do valor padrão)
  createdAt DateTime @default(now())

  @@unique([planId, benefitId])
  @@map("plan_benefits")
}

/// Parceiro / Empresa local
model Parceiro {
  id          String  @id @default(cuid())
  userId      String  @unique
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  cnpj        String  @unique @db.VarChar(14)
  companyName String
  tradeName   String? // Nome fantasia
  logo        String?
  category    String
  description String? @db.Text

  cityId String
  city   City   @relation(fields: [cityId], references: [id])

  address Json // {street, number, complement, neighborhood, zipCode, coordinates}
  contact Json // {whatsapp, phone, email}
  hours   Json // [{day, dayName, open, close, isClosed}]

  balance Decimal @default(0) @db.Decimal(10, 2)
  metrics Json    @default("{\"pageViews\":0,\"whatsappClicks\":0,\"totalSales\":0,\"salesAmount\":0}")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions  Transaction[]
  benefitAccess BenefitAccess[]

  @@map("parceiros")
}

/// Assinante / Cliente do clube
model Assinante {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  cpf    String @unique @db.VarChar(11)
  name   String
  phone  String

  cityId String
  city   City   @relation(fields: [cityId], references: [id])

  address Json // {street, number, complement, neighborhood, zipCode}

  planId             String
  plan               Plan               @relation(fields: [planId], references: [id])
  subscriptionStatus SubscriptionStatus @default(PENDING)

  points   Decimal @default(0) @db.Decimal(10, 2)
  cashback Decimal @default(0) @db.Decimal(10, 2)
  qrCode   String  @unique // Gerado do CPF

  nextBillingDate DateTime?
  lastPaymentDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions Transaction[]

  @@map("assinantes")
}

/// Pivot: Benefício <-> Parceiro (quais benefícios o parceiro aceita)
model BenefitAccess {
  id         String   @id @default(cuid())
  benefitId  String
  benefit    Benefit  @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  parceiroId String
  parceiro   Parceiro @relation(fields: [parceiroId], references: [id], onDelete: Cascade)
  config     Json?    // Config específica para este parceiro
  createdAt  DateTime @default(now())

  @@unique([benefitId, parceiroId])
  @@map("benefit_access")
}

/// Transação (compra, cashback, bônus, etc)
model Transaction {
  id   String          @id @default(cuid())
  type TransactionType

  assinanteId String
  assinante   Assinante @relation(fields: [assinanteId], references: [id], onDelete: Cascade)

  parceiroId String?
  parceiro   Parceiro? @relation(fields: [parceiroId], references: [id], onDelete: SetNull)

  amount            Decimal           @db.Decimal(10, 2)
  pointsUsed        Decimal           @default(0) @db.Decimal(10, 2)
  cashbackGenerated Decimal           @default(0) @db.Decimal(10, 2)
  discountApplied   Decimal           @default(0) @db.Decimal(10, 2)

  description String
  status      TransactionStatus
  metadata    Json? // Dados adicionais (benefícios aplicados, etc)

  createdAt DateTime @default(now())

  @@index([assinanteId])
  @@index([parceiroId])
  @@index([createdAt])
  @@map("transactions")
}

/// Configurações do sistema
model Config {
  id          String         @id @default(cuid())
  key         String         @unique
  value       String         @db.Text
  description String
  category    ConfigCategory
  updatedAt   DateTime       @updatedAt

  @@map("configs")
}

/// Integrações externas (Evolution API, Mercado Pago, etc)
model Integration {
  id        String          @id @default(cuid())
  type      IntegrationType
  name      String
  config    Json            // Credenciais e configurações (criptografado na aplicação)
  isActive  Boolean         @default(true)
  lastSync  DateTime?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@unique([type])
  @@map("integrations")
}

/// Logs do sistema (para developer)
model SystemLog {
  id        String   @id @default(cuid())
  level     String   // info, warn, error
  action    String   // ação realizada
  userId    String?  // usuário que realizou (se aplicável)
  details   Json?    // detalhes adicionais
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([level])
  @@index([action])
  @@index([userId])
  @@index([createdAt])
  @@map("system_logs")
}
